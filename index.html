<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Offline-first quiz engine for effective active recall">
    <meta name="theme-color" content="#4361ee">
    <meta name="color-scheme" content="light dark">

    <title>Quiz Engine</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./app.webmanifest">

    <!-- Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <style>
        /* Critical CSS inline for fast first paint */
        :root { --primary: #4361ee; --bg: #f8f9fa; }
        [data-theme="dark"] { --bg: #1a202c; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); }
        .screen { display: none; }
        .screen.active { display: block; }
        #loading { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        /* Modal critical styles */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    </style>

    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-banner" style="display: none;">
        <span>üì° You are offline. Quiz Engine is working locally.</span>
    </div>

    <!-- Loading State -->
    <div id="loading" role="status" aria-live="polite">
        <div style="text-align: center;">
            <div style="font-size: 3rem; animation: pulse 1.5s infinite;">üìö</div>
            <p>Loading Quiz Engine...</p>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <!-- Navigation / Header -->
        <nav class="main-nav" role="navigation" aria-label="Main navigation">
            <div class="nav-brand">
                <h1>üìö Quiz Engine</h1>
            </div>
            <div class="nav-controls">
                <button id="install-btn" class="btn-icon install-btn" style="display: none;" aria-label="Install app" title="Install to home screen">
                    <span aria-hidden="true">‚¨áÔ∏è</span>
                </button>
                <button id="theme-toggle" class="btn-icon" aria-label="Toggle dark mode" title="Toggle theme (Ctrl+T)">
                    <span aria-hidden="true">üåô</span>
                </button>
                <a href="#/welcome" class="btn-icon" aria-label="Go to home" title="Home">üè†</a>
            </div>
        </nav>

        <!-- Notification Area -->
        <div id="notification-area" role="status" aria-live="polite" class="sr-only"></div>

        <!-- SCREEN 1: Welcome/Import -->
        <section id="welcome-screen" class="screen" aria-labelledby="welcome-heading">
            <header>
                <h1 id="welcome-heading">Active Recall Study Tool</h1>
                <p class="subtitle">Import quiz files or select from your library</p>
            </header>

            <div class="card">
                <div class="card-header">
                    <h2>Import Quiz</h2>
                    <span class="requirement-badge">JSON</span>
                </div>

                <div class="drop-zone" id="drop-zone" role="button" tabindex="0" aria-label="Import quiz file. Drag and drop or click to browse.">
                    <div class="drop-icon" aria-hidden="true">üìÑ</div>
                    <p><strong>Drag & drop quiz JSON file here</strong></p>
                    <p class="small">or</p>
                    <button id="browse-btn" class="btn-primary" type="button">Browse Files</button>
                    <input type="file" id="file-input" accept=".json,application/json" hidden aria-label="Select quiz file">

                    <details class="format-info">
                        <summary>View Required Format</summary>
                        <pre><code>{
  "metadata": {
    "title": "Quiz Title",
    "subject": "Subject",
    "source": "Source",
    "questionCount": 10,
    "tags": ["optional", "tags"]
  },
  "questions": [...]
}</code></pre>
                    </details>
                </div>

                <div id="error-display" class="error-box" style="display: none;" role="alert" aria-live="assertive">
                    <h3>‚ùå Import Failed</h3>
                    <ul id="error-list"></ul>
                </div>
            </div>

            <!-- Storage Stats -->
            <div class="card storage-info" style="display: none;">
                <h3>Storage Usage</h3>
                <div class="storage-bar">
                    <div class="storage-fill" id="storage-fill"></div>
                </div>
                <p class="small" id="storage-text">0 MB / 5 MB used</p>
                <button id="export-all-btn" class="btn-outline btn-small">Export All Data</button>
            </div>

            <!-- Recently loaded quizzes -->
            <section id="recent-quizzes" class="card" style="display: none;" aria-labelledby="recent-heading">
                <div class="section-header">
                    <h2 id="recent-heading">Your Quiz Library</h2>
                    <div class="section-actions">
                        <button id="bulk-toggle-btn" class="btn-text" style="display: none;">Select Multiple</button>
                        <button id="clear-all-btn" class="btn-text danger" style="display: none;">Clear All</button>
                    </div>
                </div>

                <!-- Bulk Actions Bar -->
                <div id="bulk-actions" class="bulk-actions">
                    <div class="bulk-info">
                        <span id="bulk-count">0 selected</span>
                    </div>
                    <div class="bulk-buttons">
                        <button id="bulk-select-all" class="btn-small btn-text">Select All</button>
                        <button id="bulk-deselect-all" class="btn-small btn-text">Deselect All</button>
                        <button id="bulk-export-btn" class="btn-small btn-outline" disabled>Export Selected</button>
                        <button id="bulk-delete-btn" class="btn-small btn-danger" disabled>Delete Selected</button>
                    </div>
                </div>

                <div id="quiz-list" role="list" aria-label="Available quizzes"></div>
            </section>
        </section>

        <!-- Quiz Preview Modal -->
        <div id="preview-modal" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="preview-title">
            <div class="modal preview-modal">
                <div class="modal-header">
                    <h2 id="preview-title">Quiz Title</h2>
                    <button id="preview-close-btn" class="btn-icon" aria-label="Close preview">‚úï</button>
                </div>

                <div class="preview-content">
                    <div class="preview-meta">
                        <div class="preview-meta-item">
                            <span class="preview-label">Subject:</span>
                            <span id="preview-subject">-</span>
                        </div>
                        <div class="preview-meta-item">
                            <span class="preview-label">Questions:</span>
                            <span id="preview-count">-</span>
                        </div>
                        <div class="preview-meta-item">
                            <span class="preview-label">Source:</span>
                            <span id="preview-source">-</span>
                        </div>
                    </div>

                    <div id="preview-tags" class="preview-tags"></div>

                    <div class="preview-options">
                        <h3>Quiz Options</h3>

                        <label class="toggle-option">
                            <input type="checkbox" id="preview-shuffle-toggle">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">
                                <strong>Shuffle Questions</strong>
                                <small>Randomize question order for this session</small>
                            </span>
                        </label>

                        <label class="toggle-option">
                            <input type="checkbox" id="preview-study-toggle">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">
                                <strong>Study Mode</strong>
                                <small>Show explanations immediately after answering</small>
                            </span>
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="preview-start-btn" class="btn-primary btn-large">Start Quiz</button>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: Quiz Runner -->
        <section id="quiz-screen" class="screen" aria-labelledby="quiz-title">
            <!-- Mode Indicators -->
            <div class="mode-indicators">
                <span id="shuffle-indicator" class="mode-badge" style="display: none;">üîÄ Shuffled</span>
                <span id="study-mode-indicator" class="mode-badge study" style="display: none;">üìñ Study Mode</span>
            </div>

            <header class="quiz-header">
                <div class="quiz-meta">
                    <h1 id="quiz-title">Quiz Title</h1>
                    <div class="quiz-subject" id="quiz-subject">Subject</div>
                </div>
                <div class="quiz-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Quiz progress" id="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text">
                        Question <span id="current-question">1</span> of <span id="total-questions">10</span>
                    </div>
                </div>
            </header>

            <!-- Question Navigator -->
            <div id="question-navigator" class="question-navigator" aria-label="Question navigation"></div>

            <div class="quiz-card">
                <div class="question-content">
                    <h2 id="question-text" class="question-text">Question will appear here...</h2>

                    <div id="options-container" class="options-grid" role="radiogroup" aria-labelledby="question-text">
                        <!-- Options injected here -->
                    </div>

                    <!-- Study Mode Explanation -->
                    <div id="study-explanation" class="study-explanation" style="display: none;"></div>

                    <div class="quiz-controls">
                        <button id="prev-btn" class="btn-secondary" type="button" disabled aria-label="Previous question">
                            ‚Üê Previous
                        </button>
                        <div class="quiz-status" aria-live="polite">
                            <span id="selected-status">Not answered</span>
                        </div>
                        <button id="next-btn" class="btn-primary" type="button" aria-label="Next question">
                            Next ‚Üí
                        </button>
                        <button id="submit-btn" class="btn-success" type="button" style="display: none;">
                            Submit Quiz
                        </button>
                    </div>
                </div>
            </div>

            <div class="navigation-hint">
                <kbd>1</kbd>-<kbd>6</kbd> Select <span aria-hidden="true">‚Ä¢</span> <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate <span aria-hidden="true">‚Ä¢</span> <kbd>Enter</kbd> Confirm
            </div>
        </section>

        <!-- SCREEN 3: Results -->
        <section id="results-screen" class="screen" aria-labelledby="results-heading">
            <div class="results-card">
                <div class="results-header">
                    <div id="score-circle" role="img" aria-label="Score: 0%">
                        <span id="score-percent">0%</span>
                    </div>
                    <h1 id="results-heading">Quiz Complete!</h1>
                    <p id="quiz-metadata">Title ‚Ä¢ Subject ‚Ä¢ X questions</p>
                </div>

                <div class="results-stats" role="list" aria-label="Score statistics">
                    <div class="stat" role="listitem">
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat" role="listitem">
                        <div class="stat-value" id="incorrect-count">0</div>
                        <div class="stat-label">Incorrect</div>
                    </div>
                    <div class="stat" role="listitem">
                        <div class="stat-value" id="percentage">0%</div>
                        <div class="stat-label">Score</div>
                    </div>
                </div>

                <section id="review-section" aria-labelledby="review-heading">
                    <h2 id="review-heading">Review Answers</h2>
                    <div id="review-questions"></div>
                </section>

                <div class="results-controls">
                    <button id="restart-btn" class="btn-secondary" type="button">Restart Quiz</button>
                    <a href="#/welcome" class="btn-primary" role="button">Load New Quiz</a>
                    <button id="export-btn" class="btn-outline" type="button">Export Results</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Scripts -->
    <script src="./validator.js"></script>
    <script src="./quiz-storage.js"></script>
    <script src="./app.js"></script>
</body>
</html>
